---
title: Authenticating using OIDC
id: oidc-auth
sidebar_position: 2
published: "2024-09-04"
edited: "2024-09-04"
---

To complete the LTI message flow we need to perform an OIDC authentication step as seen here

![image of the OIDC authentication part within the LTI workflow](/assets/img/lti-launch-sequence-oidc.png)

## Overview

When a user clicks on an LTI link within Learn, the Learn server receives a GET request from the browser with information about that LTI link. Once it loads the tool configuration associated with that link the first thing it does is initiate the OIDC Login request with a browser redirect to the registered OIDC Login URI provided by your tool when registering on the Developer Portal. The initial login request also passes some information along as query parameters.

The data sent by Learn to the OIDC login endpoint of your tool is the following:

- issuer
- login_hint - an opaque value to the tool that must be returned back
- target_link_uri - the URI configured by the tool for this LTI link
- lti_message_hint - an opaque value to the tool that must be returned back
- lti_deployment_id - this is optional, but Learn always sends it
- client_id - this is optional, but Learn always sends it
- lti_storage_target - for use if cookies aren't possible

Once the request is received, your tool must then redirect to the registered OIDC Authentication Request URI provided by the Developer Portal (shown when the registration process was completed), including a Redirect URI (which must be pre-registered) and a state value, along with the other values passed in by the platform. The Redirect URI declares where the tool wants the subsequent LTI launch to go, and the state is what protects against CSRF. The state should be saved in a cookie, so the tool can verify that the initiator of the request is the same browser that sends the LTI message launch. If a cookie cannot work because of browser restrictions preventing setting of cookies by 3rd parties in iframes, then another option must be pursued such as lti_storage_target.

:::caution Redirect URI
Make sure that the Redirect URI is encoded using URLEncode before redirecting to the OIDC endpoint of the Developer Portal. Failure to encode that value could result on broken workflows
:::

The fields the tool must send on the redirect to the Developer Portal are:

- response_type=id_token
- scope=open_id
- login_hint - received as a parameter on the login request from Learn
- lti_message_hint - received as a parameter on the login request from Learn
- state - a random value generated by your tool to prevent CRSF attacks
- nonce - a random value generated by your tool to prevent duplicate requests
- redirect_uri - a pre-registered URL of your tool where the LTI POST with the data will be sent **(MUST BE ENCODED)**
- client_id - The Client ID (or Application ID) of your tool

:::danger login_hint and lti_message_hint values
The values for the `login_hint` and `lti_message_hint` must be sent to the Developer Portal on the redirect **unaltered** since those contain information critical for the workflow and are verified in subsequent calls
:::

## Sample code

Below you can find sample code that outline how the OIDC redirect can be performed

#### NodeJS

```node
exports.oidcLogin = function(req, res) {
  const state = uuid.v4(); // save this locally, such as in a cookie; optional in the OIDC spec
  const nonce = uuid.v4(); // Used to prevent playback
  const client = // You'll need to determine the client ID for this request from parameters on the request
  const redirectUri = // Get the Redirect URI for this client
  const oidcAuthUrl = // The URL you were given for this client when you registered your application

  let url =
    oidcAuthUrl +
    "?response_type=id_token" +
    "&scope=openid" +
    "&login_hint=" +
    req.query.login_hint +
    "&lti_message_hint=" +
    req.query.lti_message_hint +
    "&state=" +
    state +
    "&redirect_uri=" +
    encodeURIComponent(redirectUri) +
    "&client_id=" +
    clientId +
    "&nonce=" +
    nonce;

  res.redirect(url);
};
```
